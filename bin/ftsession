#!/bin/sh
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program. If not, see <http://www.gnu.org/licenses/>.
#
# Copyright 2023 Jeremy Brubaker <jbru362@gmail.com>
#
# Inspired by:
#   https://github.com/junegunn/fzf/wiki/examples#general
#
# Defaults {{{1
#
ACTIVE_CLR_DFLT=2
FMT_DFLT="%d %b %y"

# Documentation {{{1
#
VERSION='1.0'

print_help() {
    cat <<END >&2
Usage: $0 [OPTION] [QUERY]

Use fzf to switch to or kill a tmux session

QUERY can be used to refine the initial search

  -n         do not colorize tags and url preview
  -c [COLOR] color to highlight the current session
               (256-color number, default = $TAG_CLR_DFLT)
  -f [FMT]   date format, default = $FMT_DFLT
  -s         switch sessions (default)
  -k         kill session
  -h   	     display this help and exit
  -v         output version information and exit
END
}

print_version() {
    cat <<END >&2
$0 $VERSION
Copyright (C) 2023 Orion Arts
License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>.
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.

Written by Jeremy Brubaker.
END
}

# Process options {{{1
#
ansi=--ansi
active_color=$(tput setaf "$ACTIVE_CLR_DFLT")
reset=$(tput sgr0)

datefmt=$FMT_DFLT

cmd=switch

while getopts ':nc:f:kshv' c; do
    case $c in
        n) active_color= ; reset= ; ansi= ;;
        c) active_color=$(tput setaf "$OPTARG") ;;
        f) datefmt=$OPTARG ;;
        k) cmd=kill ;;
        s) cmd=switch ;;
        h) print_help; exit 0 ;;
        v) print_version; exit 0 ;;
        ?) printf "Invalid option: -%s\n" "$OPTARG" >&2; print_help; exit 1 ;;
    esac
done
shift $((OPTIND-1))

# Main {{{1
#
current=$(tmux display-message -p "#S")
header="NAME,GROUP,CREATED"
format="#{session_name}#{session_group}#{t/f/${datefmt}:session_created}"

# shellcheck disable=SC2086
target=$(
    tmux list-sessions -F "$format" |
        column -t -s -N "$header" |
        sed -e "/^$current /!s/^/  /" \
            -e "s/^\($current .*\)/* $active_color&$reset/" |
        fzf --header-lines 1 \
        $ansi \
            --query "$1" \
            --exit-0 |
        sed 's/^\*//' |
        awk '{print $1}'
    )

[ -z "$target" ] && exit

case $cmd in
    switch) echo tmux switch-client -t "$target" ;;
    kill)   echo tmux kill-session -t "$target" ;;
    *)      printf "Unknown command: %s\n" "$cmd" >&2 ;;
esac

